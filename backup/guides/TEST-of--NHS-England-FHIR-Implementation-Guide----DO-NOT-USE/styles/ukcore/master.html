<!DOCTYPE html>
<html lang="en-GB">

    <head>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>{{ guide-title }}</title>

        <link rel="icon" href="{{content}}/styles/common/favicon.ico" />
        <link rel="stylesheet" href="{{content}}/styles/common/main.min.css" />
        <link rel="stylesheet" href="{{content}}/styles/common/bootstrap/bootstrap.min.css" />
        <link rel="stylesheet" href="{{content}}/styles/common/rendering/rendering.min.css" />
        <link rel="stylesheet" href="{{content}}/{{style-folder}}/style.css?v={{version}}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

    <link href="https://design-system.digital.nhs.uk/" rel="preconnect" crossorigin="">
    <link rel="stylesheet" href="https://design-system.digital.nhs.uk/cdn/v0.97.0/stylesheets/nhsd-frontend.css" media="screen" type="text/css" />
    <link rel="stylesheet" href="//nhs-prod.global.ssl.fastly.net/webfiles/1629803351410/dist/nhsd-frontend-edge-cases.css" media="screen" type="text/css" />

    <link type="font/woff2" href="https://dbs1dgg3cdf4v.cloudfront.net/cdn/latest/fonts/FrutigerLTW01-55Roman.woff2" rel="preload" as="font" crossorigin>
    <link type="font/woff2" href="https://dbs1dgg3cdf4v.cloudfront.net/cdn/latest/fonts/FrutigerLTW01-65Bold.woff2" rel="preload" as="font" crossorigin>
    <link type="font/woff2" href="https://dbs1dgg3cdf4v.cloudfront.net/cdn/latest/fonts/FrutigerLTW01-45Light.woff2" rel="preload" as="font" crossorigin>

        <script src="{{content}}/styles/common/jquery/jquery.min.js"></script>
        <script src="{{content}}/styles/common/bootstrap/bootstrap.min.js"></script>
        <script src="{{content}}/styles/common/rendering/stu3TreeTable.min.js"></script>
        <script src="{{content}}/styles/common/rendering/baseTreetable.min.js"></script>
    </head>

    <body>

        <header>

            <div class="container">
                <div id="header" class="row">
                    <div class="col-md-4 hl7-fhir-logo-lhs">
                        <a href="https://digital.nhs.uk/">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/NHS_England_logo.svg/2560px-NHS_England_logo.svg.png" width="100" alt="NHS England logo"/>
                        </a>
                    </div>
                    <div class="col-md-16">
                            <h3 align="center" class="guide-title">{{ guide-title }}</h3>
                    </div>
                    <div class="col-md-4 hl7-logo" style="margin-top:15px;">
                        <a href="https://www.hl7.org/fhir/{{guide-fhir-version}}">
                           <img src="https://www.hl7.org/fhir/assets/images/fhir-logo-www.png" width="200" alt="HL7 FHIR logo"/>
                        </a> 
                    </div>

                </div>
            </div>
            {{ dropdown-navigation }}
        </header>

        <!-- Implementation guide content -->
        <div class="content container">

            <!-- Header to be displayed on each page -->
            <!--Comment out for publication, start-->

            <div id="header" class="row">


            <div markdown="span" class="alert alert-danger" role="alert">
                <h4><i class="fa fa-warning"></i> WARNING</h4>
                <ul>
                <li>This is a development IG, used by the NHS England Interoperability Standards team to test new features ahead of release.</li>
                <li>This IG should not be used to implement FHIR.</li>
</div>
</div>
            <!--Comment out for publication, end-->


            {{ page-with-children }}
        </div>

        <!-- back to top button -->
        <a id="back-to-top" class="btn btn-fhir" onclick="goBackToTop()">
            back to top
        </a>

        <footer>
            <!--<div class="container">

                <div class="row">
                    <div>
                        <span>Version: {{ guide-version }}</span>
                        <span>FHIR Version: {{ guide-fhir-version }}</span>
                    </div>

                    <br />
                    <p>Powered by <b>SIMPLIFIER.NET</b></p>
                    <div>
                        HL7<sup>&reg;</sup> and FHIR<sup>&reg;</sup> are the registered trademarks of Health Level Seven
                        International
                    </div>
                </div>
            </div>-->
            <div class="container">
                <table width="100%">
                    	<col style="width:25%">
	                    <col style="width:15%">
    	                <col style="width:20%">
	                    <col style="width:15%">
    	                <col style="width:25%">
                  <tr>
                      <td>Powered by <b>SIMPLIFIER.NET</b></td>
                      <td> IG © 2021+ HL7 UK</td>
                      <td> <span><b>Version:</b> {{ guide-version }}</span></td>
                      <td><span><b>FHIR Version:</b> {{ guide-fhir-version }}</span></td>
                      <td><b>Packages are based on:</b>  <a href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a> </td>
                      
                  </tr>
                  </table>
                <table width="100%">
                    	<col style="width:25%">
	                    <col style="width:15%">
    	                <col style="width:20%">
	                    <col style="width:15%">
    	                <col style="width:25%">
                  <tr>
                    <td><b>Released:</b> not for public use</td>
                    <td colspan="4"><b>Links:</b>&nbsp;<a id="footer-sitemap" href="{{content}}/../Home/Guidance/Sitemap-Overview?version={{ guide-version }}">Table of contents</a> | <a id="footer-history" href="">Version history</a> | <a id="footer-licence" href="{{content}}/../?version={{ guide-version }}#I1">Licence</a> | <a id="footer-propose" href="https://simplifier.net/NHS-England-Implementation-Guide/~issues">Propose a change</a></td>
                      </tr>  
                    </table>
            </div>
        </footer>

        <script>
            //Back to top button functionality
            var backToTopButton = document.getElementById("back-to-top");

            // When the user scrolls down 100px from the top of the document, show the button
            window.onscroll = function () { handleScrolling() };

            function handleScrolling() {
                showTopButton();
                scrollProfileSideBar();
            }

            function showTopButton() {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    backToTopButton.style.display = "block";
                } else {
                    backToTopButton.style.display = "none";
                }
            }

            function scrollProfileSideBar() {
                var hasSDH1 = $('div#preview-content h1[id^=structuredefinition-England]');
                if (hasSDH1 != undefined && hasSDH1.length > 0)
                {
                    if (hasSDH1[0].getBoundingClientRect().top < 0) {
                        var amountToMove=hasSDH1[0].getBoundingClientRect().top * -1;
                        $("div.col-md-6").css({
                            "top": amountToMove + 20 + "px"
                        });
                    } else {
                        $("div.col-md-6").css({
                             "top": "0"
                        });
                    }
                }
            }
            // When the user clicks on the button, scroll to the top of the document
            function goBackToTop() {
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
                $(window.location)[0].replace("#");
            }

            //Ensures footer is at the bottom of the page 
            function updateFooterPosition() {
                var bottomOfFooter = $('footer').offset().top + $('footer').outerHeight(true);
                var heightShortage = $(document).height() - bottomOfFooter;
                if (heightShortage < 0) heightShortage = 0;
                $('footer').css('margin-top', heightShortage);
            }

            function openTab(evt, tabName) {
                // Find the element that has been clicked with jQuery
                var element = $(evt.target);

                // Remove the current class of .active in the buttons next to it
                element.parent().find(".tablinks").removeClass("active");

                // Add a class of .active to the clicked tab
                element.addClass("active");

                // Cache the parent of the button clicked
                var parent = element.parent().parent();

                // Clear out the current view (e.g. Table, XML, JSON)
                parent.find(".tabcontent").hide(0);

                // Show the desired content with the current view
                parent.find(".tabcontent[id='"+tabName+"']").show(0);
            }

            // function to turn multiple columns into rows for an fql table, within a specific div
            function transposeFQLTables() {
                //look for a div with id transpose
                $('div#transpose').each(function(index) {
                    //within this div, look for an fql table
                    var fqlTable = $(this).children("table.table-bordered");
                    //and optionally a 2 column table you want to combine with the transposed one
                    var contextTable = $(this).children("table#addToTranspose");

                    //only continue to transpose if we have an fql table
                    if (fqlTable != undefined && fqlTable.length > 0) {

                    //create a new table to be populated during the transpose
                    var newTable = document.createElement('table');
                    newTable.classList.add("table-bordered");
                    newTable.classList.add("scrollbar");
                    
                    // Find the max number of columns in the fql table
                    var maxColumns = 0;
                    for(var r = 0; r < fqlTable[0].rows.length; r++) {
                        if(fqlTable[0].rows[r].cells.length > maxColumns) {
                            maxColumns = fqlTable[0].rows[r].cells.length;
                        }
                    }                   

                    //create the header row
                    let header = newTable.createTHead();
                    let headerRow = header.insertRow();
                    headerRow.innerHTML= '<th colspan=2>Profile Details</th>';

                    //populate the body by transposing columns to rows
                    let body = newTable.createTBody();
                    for(var c = 0; c < maxColumns; c++) {
                        let addedRow = body.insertRow(c);
                        var isCanonicalURL = false;
                        for(var r = 0; r < fqlTable[0].rows.length; r++) {
                            if(r==0) {
                                if (fqlTable[0].rows[r].cells[c].innerText == "Canonical_URL"){
                                    isCanonicalURL= true;
                                }
                                addedRow.insertCell(r);
                                addedRow.cells[r].innerHTML = "<b>" + fqlTable[0].rows[r].cells[c].innerHTML.split("_").join(" ") + "</b>";
                                addedRow.cells[r].classList.add('width20');
                            }
                            else {
                                addedRow.insertCell(r);

                                pTag = "<p>";
                                pTagClose = "</p>"
                                if (isCanonicalURL) {
                                    str = fqlTable[0].rows[r].cells[c].innerText;
                                } else {
                                    str = fqlTable[0].rows[r].cells[c].innerHTML;
                                }

                                str = str.replace(pTag, '');
                                str = str.replace(pTagClose, '');
                                addedRow.cells[r].innerHTML = str;
                            }
                        }
                    }

                    //optionally add rows from a two column table to be joined to the bottom of the transposed table
                    if (contextTable != undefined && contextTable.length > 0) {
                        let addedRow = body.insertRow(c);
                        for(var r = 0; r < contextTable[0].rows.length; r++) {
                            addedRow.insertCell(-1);
                            addedRow.cells[0].innerHTML = "<b>" + contextTable[0].rows[r].cells[0].innerHTML.split("_").join(" ") + "</b>";
                            addedRow.cells[0].classList.add('width20');
                            addedRow.insertCell(-1);
                            addedRow.cells[1].innerHTML = contextTable[0].rows[r].cells[1].innerHTML;
                        }
                    }

                    //add the transposed table to the div, and remove the other tables
                    $(this).append(newTable);
                    fqlTable.remove();
                    contextTable.remove();
                    }
                });
			}

            // function to turn the first column of an fql table into a concatentated string, within a specific span
            function detablifyUsageFQL() {

                let url = window.location.href;
                let pageVersion = "?" + url.split("?")[1];
                let slashCount = url.split("/").length;
                let newUrl='';
                let iSlashRemove = 1;
                if (url.split("?")[0].endsWith('.page.md')) {
                    iSlashRemove = 2;
                }
                for (i=0;i<slashCount-iSlashRemove;i++) {
                    newUrl = newUrl + url.split("/")[i] + "/";
                }

                //look for a span with id usage
                $('span#usage').each(function(index) {
                    //within this span, look for an fql table                    
                    var fqlTable = $(this).children("table.table-bordered");
                    var stringToSet = "";
                    //only continue to de-table'ify if we have an fql table
                    if (fqlTable != undefined && fqlTable.length > 0) {
                        for(var r = 1; r < fqlTable[0].rows.length; r++) {
                            var profile = fqlTable[0].rows[r].cells[0].innerHTML;
                            if (stringToSet != "") {
                                stringToSet += ", ";
                            }
                            let thisUrl = '';
                            if (profile.startsWith("Extension")) {
                                if (pageVersion.startsWith("?version=current")){
                                    thisUrl = newUrl + "ExtensionLibrary/" + profile +  ".page.md" + pageVersion;
                                } else
                                {
                                    thisUrl = newUrl + "ExtensionLibrary/" + profile + pageVersion;
                                }
                            } else
                            {
                                thisUrl = newUrl + "Profile-" + profile + pageVersion;
                            }
                            profile = "<a href=" + thisUrl + ">" + profile + "</a>";
                            stringToSet += profile;
                        }
                    }
                     if (stringToSet == "") {
                        stringToSet = "None";
                    }
                    $(this).replaceWith(stringToSet);
                });
            }

            // function alters styling of FQL tables
            function tidyUpFQLTables() {
                //fix the contents of FQL table headers
                // specifically swap _ for spaces, and change ProfilePurpose to have a space
                $('table.table-bordered > thead > tr > th').each(function(index) {
                    if ($(this).text() == 'ProfilePurpose') {
                            $(this).text('Profile Purpose');
                    }
                    $(this).text($(this).text().split("_").join(" "));
                });

                //remove the FQL table css on CodeSystems/Extensions when they are in a list page
                $('[id^=CodeSystem-England-] > table.table-bordered').each(function(index) {
                    $(this).removeClass('scrollbar');
                    $(this).removeClass('table-bordered');
                    $(this).removeClass('table');
                });

                //for any remaining FQL tables, remove the scrollbar, and add our England assets and forceWhite class
                $('table.table-bordered').each(function(index) {
                    $(this).removeClass('scrollbar');
                    $(this).addClass('assets');
                    $(this).addClass('forceWhite');
                });
            }

            // function handles changing new items to be green
            function highlightBallotItems() {
                //new balloted assets should have an info div on them, 
                // this changes the sub pages to be green, and forces the info box and trees/tabs to be white
                $('div#newAsset').each(function(index){
                    //this check handles the sub page in All Extensions/ValueSets/CodeSystems
                    // without it, the whole list goes green
                    // NOTE:
                    //  Codesystem, Valueset, codesystem, valueSet etc will still cause page to go full green
                    //  ensure your Page Title, FileName and Topic are capitalised right
                    var parentCodeSystem = $(this).closest('[id^=CodeSystem-England-]'); 
                    var parentExtension = $(this).closest('[id^=Extension-England-]');
                    var parentValueSet = $(this).closest('[id^=ValueSet-England-]');
                   
                    if (parentCodeSystem != undefined && parentCodeSystem.length > 0)
                    {
                        parentCodeSystem.addClass('forceGreen');
                        $(this).parent().find('h2').addClass('forceGreen');
                        $(this).parent().find('hr').insertAfter($(this).parent())
                    } else if (parentExtension != undefined && parentExtension.length > 0)
                    {
                        parentExtension.addClass('forceGreen');
                        $(this).parent().find('h2').addClass('forceGreen');
                        $(this).parent().find('hr').insertAfter($(this).parent())
                    } else if (parentValueSet != undefined && parentValueSet.length > 0)
                    {
                        parentValueSet.addClass('forceGreen');
                        $(this).parent().find('h2').addClass('forceGreen');
                        $(this).parent().find('hr').insertAfter($(this).parent())
                    } else
                    {
                        $('div.row:not(#header)').addClass('forceGreen');
                        $(this).parent().find('hr').addClass('forceWhite');
                    }
                    $(this).addClass('forceWhite');
                    $(this).parent().find('div.tabcontent').addClass('forceWhite');
                });
            }

            // function adds a hr line item after Extension/Bindings/Constraints
            // and one before any uk core access guidance
            // in the left hand list, AND the same on the main page
            function separateOutGuidance() {
                var hasSDH1 = $('div#preview-content h1[id^=structuredefinition-England]');
                if (hasSDH1 != undefined && hasSDH1.length > 0)
                {
                    var firstLi = $('ul.nav-stacked li:first');
                    if (firstLi != undefined && firstLi.length > 0) {
                        firstLi.before("<li><a title='Profile' href='#" + hasSDH1[0].id +  "'>Profile</a></li>");
                    }

                    var mvcLi = $('ul.nav-stacked li a[title|="Minimum Viable Content"]');
                    var extensionsLi = $('ul.nav-stacked li a[title|="Extensions"]');
                    var bindingsLi = $('ul.nav-stacked li a[title|="Bindings"]');
                    var constraintsLi = $('ul.nav-stacked li a[title|="Constraints"]');

                    var patientApiLi = $('ul.nav-stacked li a[title|="Patient Index Provider"]');
                    var clinicalApiLi = $('ul.nav-stacked li a[title|="Clinical Data Provider"]');

                    if (constraintsLi != undefined && constraintsLi.length > 0) {
                        constraintsLi.after("<li><hr></li>");
                    } else if (bindingsLi != undefined && bindingsLi.length > 0) {
                        bindingsLi.after("<li><hr></li>");
                    } else if (extensionsLi != undefined && extensionsLi.length > 0) {
                        extensionsLi.after("<li><hr></li>");
                    } else if (mvcLi != undefined && mvcLi.length > 0) {
                        mvcLi.after("<li><hr></li>");
                    }

                    if (patientApiLi != undefined && patientApiLi.length > 0)
                    {
                        patientApiLi.before("<li><hr></li>");
                    }
                    if (clinicalApiLi != undefined && clinicalApiLi.length > 0)
                    {
                        clinicalApiLi.before("<li><hr></li>");
                    }

                    var extensionsDiv = $('div#preview-content div#extensions');
                    var extensionsDivUC = $('div#preview-content div#Extensions');
                    var mvcDiv = $('div#preview-content div#Minimum-Viable-Content');
                    var bindingsDiv = $('div#preview-content div#Bindings');
                    var constraintsDiv = $('div#preview-content div#Constraints');
                    var checkForHR;
                    var addToDiv;

                    //check for a hr at the end, and if not, add one, or give it a class
                    if (constraintsDiv != undefined && constraintsDiv.length > 0) {
                        checkForHR = constraintsDiv.children('hr');
                        addToDiv = constraintsDiv;
                    } else if (bindingsDiv != undefined && bindingsDiv.length > 0) {
                        checkForHR = bindingsDiv.children('hr');
                        addToDiv = bindingsDiv;
                    } else if (extensionsDiv != undefined && extensionsDiv.length > 0) {
                        checkForHR = extensionsDiv.children('hr');
                        addToDiv = extensionsDiv;
                    } else if (extensionsDivUC != undefined && extensionsDivUC.length > 0) {
                        checkForHR = extensionsDivUC.children('hr');
                        addToDiv = extensionsDivUC;
                    } else if (mvcDiv != undefined && mvcDiv.length > 0) {
                        checkForHR = mvcDiv.children('hr');
                        addToDiv = mvcDiv;
                    }
                    if (checkForHR != undefined && checkForHR.length > 0) {
                        checkForHR.addClass('thickline');
                    } else {
                        if (addToDiv != undefined && addToDiv.length > 0) {
                            addToDiv.append("<hr class='thickline'>");
                        }
                    }
                    checkForHR = undefined;
                    addToDiv = undefined;

                    var patientApiDiv = $('div#preview-content div[id$="IndexProvider"]');
                    var clinicalApiDiv = $('div#preview-content div[id$="ClinicalDataProvider"]');
                    if (patientApiDiv != undefined && patientApiDiv.length > 0) {
                        var prevDiv = patientApiDiv.prev();
                        checkForHR = prevDiv.children('hr');
                        addToDiv = prevDiv;
                    }
                    if (clinicalApiDiv != undefined && clinicalApiDiv.length > 0) {
                        var prevDiv = clinicalApiDiv.prev();
                        checkForHR = prevDiv.children('hr');
                        addToDiv = prevDiv;
                    }
                    if (checkForHR != undefined && checkForHR.length > 0) {
                        checkForHR.addClass('thickline');
                    } else {
                        if (addToDiv != undefined && addToDiv.length > 0) {
                            addToDiv.append("<hr class='thickline'>");
                        }
                    }
                }
            }
            
            // function add the submenus for profiles
            function createProfileSubMenus() {
               //mobile friendly tweak - check window size, and add sub menu if we can
                if (window.matchMedia("(min-width: 992px)").matches){
                    //add the sub menu's for profiles
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:eq(2)').after('<li class="submenu-parent"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Profiles N to Z <span class="caret"></span></a><ul class="submenu-list"></ul></li>');
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:eq(2)').after('<li class="submenu-parent"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Profiles A to M <span class="caret"></span></a><ul class="submenu-list"></ul></li>');
                    //add a seperator
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:eq(1)').after('<li role="separator" class="divider"></li>');
                    
                    //and move the items into the sub menus
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li.submenu-parent:eq(0) ul.submenu-list').append($('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:not(.submenu-parent)').slice(4,26)); //A to M
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li.submenu-parent:eq(1) ul.submenu-list').append($('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:not(.submenu-parent)').slice(26)); //N to Z
                } else {
                    //add a seperator
                    $('ul.nav li.dropdown:eq(1) ul.dropdown-menu li:eq(1)').after('<li role="separator" class="divider"></li>');
                }
            }

            // function add the submenus for terminology
            function createTerminologySeparator() {
                $('ul.nav li.dropdown:eq(2) ul.dropdown-menu li:eq(0)').after('<li role="separator" class="divider"></li>');
            }

            
            // looks for the pagetitle of Clinical Data Provider, and removes and sub h2's of Clinical Data Provider
            function hideMultipleClincialDataProviders() {
                var hasPageTitleH2 = $('h2[id^=page-title]:contains(Clinical Data Provider)');
                if (hasPageTitleH2 != undefined && hasPageTitleH2.length > 0)
                {
                    $('h2#clinical-data-provider').each(function(index){
                        $(this).remove();
                    });
                }
            }

            function swapReferenceExampleLinks() {
                //look for a div with id transpose
                var isSNOMEDCT = false;
                $("div[id='Table View'] div.path table tbody tr").each(function(index) {
                    if ($(this)[0].cells[0].innerText.endsWith("reference[0]"))
					{
						let reference = $(this)[0].cells[1].innerText;
                        if (reference.includes("/"))
                        {
                            exampleSuffix = "-Example";
                            let assetType = reference.split("/")[0];
                            let exampleName = "Example-" + reference.split("/")[1].replace(exampleSuffix,'');
                            let url = window.location.href;
                            let exampleVersion = "?" + url.split("?")[1];
                            if (exampleVersion.startsWith("?version=current")){
                                exampleVersion = ".page.md" + exampleVersion;
                            }
                            let slashCount = url.split("/").length;
                            let newUrl = '';
                            for (i=0;i<slashCount-1;i++)
                            {
                                newUrl = newUrl + url.split("/")[i] + "/";
                            }
                            if (!newUrl.endsWith("All-Examples/")) {
                                newUrl = newUrl + "All-Examples/";
                            }
                            newUrl = newUrl + exampleName + exampleVersion;
                            $(this)[0].cells[1].innerHTML = "<a href=" + newUrl + ">" + reference + "</a>";
                        }
                        isSNOMEDCT=false;
					} else if ($(this)[0].cells[0].innerText.endsWith("url[0]") || $(this)[0].cells[0].innerText.endsWith("system[0]"))
					{
                        isSNOMEDCT = false;

						let urlReference = $(this)[0].cells[1].innerText;
                        if (urlReference.includes("https://fhir.hl7.org.uk"))
                        {
                            let url = window.location.href;
                            let slashCount = url.split("/").length;
                            let newUrl = '';
                            for (i=0;i<slashCount;i++)
                            {
                                newUrl = newUrl + url.split("/")[i] + "/";
                                if (newUrl.endsWith("Home/")) {
                                    i = slashCount;
                                }
                            }
							var addExtraIfNeeded = true;
							if (urlReference.startsWith("https://fhir.hl7.org.uk/StructureDefinition/Extension-England-")) {
								newUrl = newUrl + "ProfilesandExtensions/ExtensionLibrary/Extension-England-" + urlReference.replace("https://fhir.hl7.org.uk/StructureDefinition/Extension-England-","");
							} else if (urlReference.startsWith("https://fhir.hl7.org.uk/StructureDefinition/England-")) {
								newUrl = newUrl + "ProfilesandExtensions/Profile-England-" + urlReference.replace("https://fhir.hl7.org.uk/StructureDefinition/England-","");
								addExtraIfNeeded=false;
							} else if (urlReference.startsWith("https://fhir.hl7.org.uk/ValueSet/England-")) {
								newUrl = newUrl + "Terminology/AllValueSets/ValueSet-England-" + urlReference.replace("https://fhir.hl7.org.uk/ValueSet/England-","");
							} else if (urlReference.startsWith("https://fhir.hl7.org.uk/CodeSystem/England-")) {
								newUrl = newUrl + "Terminology/AllCodeSystems/CodeSystem-England-" + urlReference.replace("https://fhir.hl7.org.uk/CodeSystem/England-","");
							}
                            let exampleVersion = "?" + url.split("?")[1];
                            if (exampleVersion.startsWith("?version=current") && addExtraIfNeeded){
                                exampleVersion = ".page.md" + exampleVersion;
                            }
                            newUrl = newUrl + exampleVersion;
                            $(this)[0].cells[1].innerHTML = "<a href=" + newUrl + ">" + urlReference + "</a>";
                        } else if (urlReference.includes("http://terminology.hl7.org"))
                        {
                            $(this)[0].cells[1].innerHTML = "<a href=" + urlReference + ">" + urlReference + "</a>";
                        } else if (urlReference.includes("http://snomed.info/sct"))
                        {
                            isSNOMEDCT= true;
                        }
					} else if ($(this)[0].cells[0].innerText.endsWith("code[0]") && isSNOMEDCT)
					{
						let conceptID = $(this)[0].cells[1].innerText;
                        $(this)[0].cells[1].innerHTML = "<a href='https://termbrowser.nhs.uk/?perspective=full&conceptId1=" + conceptID +"'>" + conceptID + "</a>";
                        isSNOMEDCT=false;
					} else {
                        isSNOMEDCT=false;
                    }
				});
			}

            //remaps {{guide-version}} to current if needed, for sitemap and licence links
            function fixFooterVersion() {
                let pageUrl = window.location.href;
                let pageVersion = "?" + pageUrl.split("?")[1];
                $("a#footer-sitemap").each(function(index) {
                    let destUrl = $(this)[0].href;
                    let destVersion = "?" + destUrl.split("?")[1];
                    if (pageVersion.startsWith("?version=current")){
                        destUrl = destUrl.replace(destVersion, pageVersion);
                    }
                    $(this).attr("href", destUrl) ;
				});
                $("a#footer-licence").each(function(index) {
                    let destUrl = $(this)[0].href;
                    let destVersion = "?" + destUrl.split("?")[1];
                    if (pageVersion.startsWith("?version=current")){
                        destUrl = destUrl.replace(destVersion, pageVersion) + '#I1';
                    }
                    $(this).attr("href", destUrl) ;
				});
			}

            function expandProfileNodes() {
                //look for any treetable parent divs
                $("div.expandedProfile div.stu3-treetable").each(function(index) {
                    //call a hacked version of the simplifier expandnode, 
                    // with the first tr as its start point, and tparent div as we lose the context their js has
                    expandProfileNode($(this).find('table.treetable').children('tbody').children('tr:first'), $(this)[0]);
                });
            }

            //copy of simplifier getVisibleElements, but with the lack of context handled
            function getVisibleElements(id, treeDiv) {
                for (var rows = '[data-ParentId="' + id + '"]', n = treeDiv.querySelectorAll(rows), i = [], r = 0, a = 0; a < n.length; a++)
                    TreeHelper.hasClass(n[a], "mode-hidden") || (i[r] = n[a],
                    r++);
                return i;
            }

            //tweaked version of simplifier expandNode
            // but is more intelligent, so only expands identifier/resource etc if sliced, or an [x] if modified
            function expandProfileNode(node, treeDiv) {
                //handle node being blank / array of tr’s / single tr
                if (node == null)
                    return;
                var n = node;
                if (node.length > 0)
                    n = node[0];

                //find all visible children, loop through them and call the click, then try and expand them
                var rows = getVisibleElements(n.getAttribute("data-id"), treeDiv);
                rows.forEach(function(e, r) {
                    var doExpand = false;
                    //check the 3 main css classes that can be set
                    var c = TreeHelper.hasClass(e, "collapsed");
                    var s = TreeHelper.hasClass(e, "sliced"); 
                    var m = TreeHelper.hasClass(e, "constraints");
                   
                    //and only expand if its collpased
                    if (c) {
                        //look inside this tr, and basically, if its not a backbone element, check if we should expand
                        var rowCellHtml = e.children[3].innerText;
                        // Identifier/Reference - if sliced/different or has an Extension, expand
                        if (rowCellHtml == "Identifier" || rowCellHtml.startsWith("Reference") )
                        {
                            if (s) {
                                doExpand = true;
                            } else {
                               var subRows = getVisibleElements(e.getAttribute("data-id"), treeDiv);
                               subRows.forEach(function(s, sr) {
                                   if (s.children[3].innerText == "Extension")
                                    doExpand = true;
                               })
                            }
                        } else if (rowCellHtml =="Coding" || rowCellHtml =="Annotation" || rowCellHtml.startsWith("Address")  || rowCellHtml.startsWith("ContactPoint") || rowCellHtml.startsWith("Extension(")) {
                            //Coding/Annotation/Address/ContactPoint/Extension(Complex)
                            //only expand if sliced 
                            if (s) 
                                doExpand = true;
                        } else if ((rowCellHtml == "" || rowCellHtml == null)) {
                                //a value[x] style element, expand if modified
                                if (m)
                                    doExpand = true;
                        } else {
                                //expand anything else (top level extension, backboneelement)
                                doExpand = true;
                        }
                        if (doExpand){
                            var o = e.querySelector(".vjoinexpandable");
                            null == o && (o = e.querySelector(".vjoinendexpandable")), 
                            null != o && o.click()
                            expandProfileNode(e, treeDiv);
                        }
                    }
                })
            }

            //funciton flips valueset expansion table visibility
            function toggleExpandedValueSetTableVisibility(anchor) {
                var table = anchor.parentElement.nextElementSibling;
                if (table.style.display != 'none') {
                    table.style.display = "none"
                } else {
                    table.style.display = "table"
                }
            }

            //code finds valuesets on their sub page / all vs page
            // and looks for the exapansion table
            // for the all valuesets, it hides this, and makes the cncoepts text abiove a link to show/hide the table, and also swaps links for snomed ct concepts to go to term browser
            // for sub page displays, just looks for expansion tables containg snomed ct concepts, and rewrites them to termbrwoser
            function alterValueSetTables() {
                // 
                $('div#preview-content div[id^=ValueSet-England] div[id^=HTML]').each(function(index) {
                    if ($(this).children('table.regular').length > 1){
                        var lookForP = $(this).children('p:contains("This value set contains")');
                        var lookForSNOMEDCT = $(this).children('ul').children('li:contains("Include codes from SNOMED_CT")');
                        var tableToAlter = $(this).children('table.regular').eq(1);

                        if (lookForP != undefined && lookForP.length > 0) {
                            lookForP[0].innerHTML = lookForP[0].innerHTML.replace("concepts","<a href='#' onclick='toggleExpandedValueSetTableVisibility(this);return false;'>concepts</a>")
                            tableToAlter.addClass('codes');
                            tableToAlter.css({
                                "display": "none"
                            });
                            tableToAlter.removeClass('regular');

                            if (lookForSNOMEDCT != undefined && lookForSNOMEDCT.length >0 ) {
                                for(var r = 1; r < tableToAlter[0].rows.length; r++) {
                                    var conceptID = tableToAlter[0].rows[r].cells[0].innerText;
                                    tableToAlter[0].rows[r].cells[0].innerHTML = "<a href='https://termbrowser.nhs.uk/?perspective=full&conceptId1=" + conceptID +"'>" + conceptID + "</a>"
                                }  
                            }
                        }
                    }
                });

                $('div#preview-content div[id^=HTML]').each(function(index) {
                    if ($(this).children('table.regular').length > 1){
                        var lookForP = $(this).children('p:contains("This value set contains")');
                        var lookForSNOMEDCT = $(this).children('ul').children('li:contains("Include codes from SNOMED_CT")');
                        var tableToAlter = $(this).children('table.regular').eq(1);
                        if (lookForP != undefined && lookForP.length > 0 && lookForSNOMEDCT != undefined && lookForSNOMEDCT.length >0 ) {
                            
                            tableToAlter.addClass('codes');
                            tableToAlter.removeClass('regular');

                            for(var r = 1; r < tableToAlter[0].rows.length; r++) {
                                var conceptID = tableToAlter[0].rows[r].cells[0].innerText;
                                tableToAlter[0].rows[r].cells[0].innerHTML = "<a href='https://termbrowser.nhs.uk/?perspective=full&conceptId1=" + conceptID +"'>" + conceptID + "</a>"
                            }  
                        }
                    }
                });
            }


            /* following chunk replicates nhse /\ and \/ sort buttons */

            //for tables with class codes (codesystems, altered valusets)
            // shift the first row into a thead
            // then call function to add /\ and \/ sort buttons
            function addCodesSortButton() {
                $('table.codes').each(function(index) {
                    var firstTr = $(this).find('tr:first').remove();
                    firstTr.find('td').contents().unwrap().wrap('<th>');
                    $(this).prepend($('<thead></thead>').append(firstTr));

                    if ($(this).find("thead tr th").length <= $(this).find("tbody tr:first td").length) {
                        $(this).find("thead tr th:last").attr('colspan',2);
                    }

                    addSortButtons($(this).parent());
                });
            }//function thats called to get the sort button chunk working
            function addSortButtons(tableDiv) {
                const tableList = tableDiv[0].querySelectorAll("table");
                if (0 === tableList.length)
                    return null;
                    
                Array.from(tableList).forEach(
                    table => {
                        normalSortButtons(table)
                    }
                )
            }

            //an array for the svg paths
            const sortObj = {
                asc: '<path d="M8,4l7,6.5L13.5,12L8,6.8L2.5,12L1,10.5L8,4z"/>',
                desc: '<path d="M8,12L1,5.5L2.5,4L8,9.2L13.5,4L15,5.5L8,12z"/>'
            };
            // a function to create the svg based on the sort type
            function getIcon(type="asc") {
                return `<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" aria-hidden="true" focusable="false" viewBox="0 0 16 16" width="100%" height="100%">\n ${sortObj[type]}\n</svg>`
            }
            //function to actually add the buttons
            function normalSortButtons(table) {
                if (void 0 !== table.dataset.noSort)
                    return;
                const headerCells = table.querySelectorAll("thead tr:first-child td, thead tr:first-child th");
                Array.from(headerCells).forEach(
                    (headerCell,index) => {
                        if (void 0 !== headerCell.dataset.noSort)
                            return;
                        headerCell.classList.add("orderable");
                        const buttonSpan = `<span class="sort-icon">${getIcon("asc")}</span>`;
                        headerCell.innerHTML = `<button><span>${headerCell.innerHTML}</span><span>${buttonSpan}</span></button>`;
                        setupSortButton(headerCell, index, table);
                    }
                )
            }
            //funciton to set up the sort button onclick
            function setupSortButton(headerCell, index, table) {
                const buttonObj = headerCell.querySelector("button");
                buttonObj.onclick = function(){sortButtonClick(headerCell, table, headerCell.dataset.sort)};
            }
            //function that actually does the onclick
            function sortButtonClick(headerCell, table){
                const hCells = table.querySelectorAll("thead td,th");
                var sortAsc = true;
                Array.from(hCells).forEach(
                    hCell => {
                        const icon = hCell.querySelector(".sort-icon");
                        if (hCell === headerCell)
                        {
                            if (headerCell.dataset.sort == undefined || headerCell.dataset.sort == "" || headerCell.dataset.sort == "desc"){
                                headerCell.dataset.sort = "asc";
                            } else {
                                headerCell.dataset.sort = "desc";
                                sortAsc=false;
                            }
                            icon.innerHTML = getIcon(headerCell.dataset.sort);
                        } else {
                            hCell.dataset.sort = "";
                            icon.innerHTML = getIcon("asc");
                        }
                    }
                )
                sortCells(headerCell.cellIndex, table, sortAsc);
            }
            //and function that does the sorting/re-tabling
            function sortCells(index, table, sortAsc) {
                const bodyList = table.querySelectorAll("tbody");
                Array.from(bodyList).forEach(
                    body => {
                        const rowArray = []
                        , rowList = body.querySelectorAll("tr");
                        Array.from(rowList).forEach(
                            (row,rowIndex) => {
                                const cell = row.querySelectorAll("td, th")[index];
                                cell && rowArray.push({
                                    row: rowIndex,
                                    value: cell.innerText
                                })
                            }
                        )
                        rowArray.sort(
                            (row1,row0) => {
                                const sortResult = sortFunction(row1.value, row0.value);
                                return false === sortAsc ? sortResult : -1 * sortResult
                            }
                        )
                        body.innerHTML = "";
                        rowArray.forEach(
                            rowItem => {
                                body.append(rowList[rowItem.row])
                            }
                        )
                    }	
                )
            }
            //function for the sort comparator
            function sortFunction(row0Value, row1Value) {
                const n = /[^a-zA-Z]/g
                , s = /[^0-9]/g
                , o = row1Value.replace(n, "")
                , i = row0Value.replace(n, "");
                if (o === i) {
                    const n = parseInt(row1Value, 15)
                    , o = parseInt(row0Value, 15);
                    return n === o ? 0 : n > o ? 1 : -1
                }
                return o > i ? 1 : -1
            }
            

            function swapProfileTreeLinks() {
                //, table.treetable tbody tr.constraints td.details p a[href$="xml"]
                $('a[href$="xml"]').each(function(index) {
                    let urlReference = $(this)[0].href;
                    if (urlReference.includes("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath="))
                    {
                        let url = window.location.href;
                        let slashCount = url.split("/").length;
                        let newUrl = '';
                        for (i=0;i<slashCount-2;i++)
                        {
                            newUrl = newUrl + url.split("/")[i] + "/";
                        }
                        
                        var addExtraIfNeeded = true;
                        if (urlReference.startsWith("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=structuredefinitions/Extension-England-")) {
                            newUrl = newUrl + "ProfilesandExtensions/ExtensionLibrary/Extension-England-" + urlReference.replace("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=structuredefinitions/Extension-England-","");
                        } else if (urlReference.startsWith("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=structuredefinitions/England-")) {
                            newUrl = newUrl + "ProfilesandExtensions/Profile-England-" + urlReference.replace("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=structuredefinitions/England-","");
                            addExtraIfNeeded=false;
                        } else if (urlReference.startsWith("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=valuesets/ValueSet-England-")) {
                            newUrl = newUrl + "Terminology/AllValueSets/ValueSet-England-" + urlReference.replace("https://simplifier.net/resolve?scopeNHS-England-Implementation-Guide@current&filepath=valuesets/ValueSet-England-","");
                        }
                        newUrl= newUrl.replace(".xml","");
                        
                        let exampleVersion = "?" + url.split("?")[1];
                        if (exampleVersion.startsWith("?version=current") && addExtraIfNeeded){
                            exampleVersion = ".page.md" + exampleVersion;
                        }
                        newUrl = newUrl + exampleVersion;
                        $(this).attr("href", newUrl);
                    }
				});
			}


            // function runs on page load
            $(function() {
                transposeFQLTables();
                detablifyUsageFQL();
                tidyUpFQLTables();
                //highlightBallotItems();
                //createProfileSubMenus();
                //createTerminologySeparator();
                //swapReferenceExampleLinks();
                //separateOutGuidance();
                //hideMultipleClincialDataProviders();
                expandProfileNodes();
                fixFooterVersion();
                alterValueSetTables();
                swapProfileTreeLinks();
                addCodesSortButton();
                updateFooterPosition();
            });
            
            $(window).resize(function () {
                updateFooterPosition();
            });
        </script>
    </body>

</html>